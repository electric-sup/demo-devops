name: CI/CD Docker Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v3

    - name: Afficher la structure
      run: |
        echo "Structure du projet :"
        ls -la
        echo ""
        echo "Contenu de index.html :"
        head -20 index.html

    - name: Validation HTML
      run: |
        echo "Validation basique du HTML..."
        if grep -q "<!DOCTYPE html>" index.html; then
          echo "âœ… HTML valide (DOCTYPE dÃ©tectÃ©)"
        else
          echo "âš ï¸  Attention : DOCTYPE non trouvÃ©"
        fi

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Construire l'image Docker
      run: |
        docker build -t demo-devops:${{ github.sha }} .

    - name: Tester le conteneur
      run: |
        # Lancer le conteneur
        docker run -d --name test-container -p 8080:80 demo-devops:${{ github.sha }}
        sleep 10
        
        # Tester l'accÃ¨s HTTP
        curl -f http://localhost:8080 || exit 1
        
        # VÃ©rifier le health check
        HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' test-container)
        echo "Health status: $HEALTH_STATUS"
        
        # VÃ©rifier les logs
        docker logs test-container
        
        # Nettoyer
        docker stop test-container
        docker rm test-container

    - name: Exporter l'image en .tar
      run: |
        docker save -o demo-devops-image.tar demo-devops:${{ github.sha }}
        echo "Fichier crÃ©Ã© :"
        ls -lh demo-devops-image.tar
        
        # Calculer le checksum
        sha256sum demo-devops-image.tar > checksum.txt
        echo "Checksum :"
        cat checksum.txt

    - name: Upload l'image .tar comme artefact
      uses: actions/upload-artifact@v3
      with:
        name: docker-image
        path: |
          demo-devops-image.tar
          checksum.txt
        retention-days: 7

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Download l'image Docker
      uses: actions/download-artifact@v3
      with:
        name: docker-image

    - name: VÃ©rifier l'intÃ©gritÃ©
      run: |
        echo "VÃ©rification du checksum..."
        sha256sum -c checksum.txt
        
        echo "Liste des fichiers :"
        ls -la

    - name: DÃ©ploiement FTP (option traditionnelle)
      uses: SamKirkland/FTP-Deploy-Action@v4.0.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: /htdocs/
        dry-run: false

    - name: DÃ©ploiement avec Docker (option avancÃ©e)
      if: false  # DÃ©sactivÃ© par dÃ©faut, Ã  activer si tu as un serveur Docker
      run: |
        echo "Cette Ã©tape dÃ©ploierait le conteneur sur un serveur Docker distant"
        echo "Exemple : docker load -i demo-devops-image.tar"
        echo "Exemple : docker run -d -p 80:80 demo-devops:${{ github.sha }}"

    - name: Rapport de dÃ©ploiement
      run: |
        echo "ðŸš€ DÃ©ploiement terminÃ© avec succÃ¨s !"
        echo "Image Docker crÃ©Ã©e : demo-devops:${{ github.sha }}"
        echo "Archive disponible : demo-devops-image.tar"
        echo "Site web dÃ©ployÃ© via FTP"
        
        # GÃ©nÃ©rer un petit rapport
        echo "### RÃ©sumÃ© du pipeline ###" >> report.md
        echo "- Commit: ${{ github.sha }}" >> report.md
        echo "- Image Docker: demo-devops:${{ github.sha }}" >> report.md
        echo "- DÃ©ploiement FTP: âœ… Complet" >> report.md
        echo "- Date: $(date)" >> report.md
        
        cat report.md