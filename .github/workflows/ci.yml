name: CI/CD Pipeline Ultimate

# TÃ¢che 2 : S'exÃ©cuter sur main ET dev
on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main

jobs:
  # JOB 1 : INTEGRATION CONTINUE (Tests & Build)
  test-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©ration du code
        uses: actions/checkout@v3

      # TÃ¢che 2 : Installer dÃ©pendances & Lancer les tests
      # Astuce de Senior : On utilise HTMLHint pour "tester" ton code HTML
      - name: ğŸ§ª Installation des outils de test
        run: sudo npm install -g htmlhint

      - name: ğŸ” ExÃ©cution des Tests (Linting)
        run: htmlhint index.html
        # Si ton HTML est mal Ã©crit, le pipeline s'arrÃªte ici !

      - name: ğŸ“¦ CrÃ©ation de l'artefact (Simulation)
        run: echo "Build artifact generated" > build.log

      - name: ğŸ“„ Afficher les logs
        run: cat build.log

  # JOB 2 : LIVRAISON & DEPLOIEMENT (Seulement si les tests passent)
  deploy:
    needs: test-and-build # Attend que les tests soient OK
    if: github.ref == 'refs/heads/main' # Ne dÃ©ploie que si on est sur MAIN
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©ration du code
        uses: actions/checkout@v3

      - name: ğŸ³ Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # TÃ¢che 4 : Construire et Pousser l'image
      - name: ğŸš€ Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/site-bryan:latest

      # TÃ¢che 5 : DÃ©ploiement (FTP InfinityFree)
      - name: ğŸ“‚ Deploy to Server (FTP)
        uses: SamKirkland/FTP-Deploy-Action@v4.0.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: /htdocs/

      # TÃ¢che 5 (Fin) : Notification
      - name: ğŸ”” Notification de succÃ¨s
        run: echo "::notice title=DÃ©ploiement::Le site a Ã©tÃ© dÃ©ployÃ© avec succÃ¨s sur InfinityFree !"